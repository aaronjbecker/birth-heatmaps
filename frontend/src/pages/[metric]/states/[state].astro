---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Heatmap from '../../../components/svelte/Heatmap.svelte';
import StateDropdown from '../../../components/svelte/StateDropdown.svelte';
import ShareButtons from '../../../components/ShareButtons.astro';
import type { StateMeta, StateHeatmapData, CountryHeatmapData } from '../../../lib/types';
import { stateToCountryFormat } from '../../../lib/normalize-data';
import { METRICS, METRIC_SLUGS, type MetricSlug } from '../../../lib/metrics';

// Import states data at module level for use in page
const statesData = await import('../../../assets/data/states.json');
const allStates = statesData.states as StateMeta[];

export async function getStaticPaths() {
  // Import states data from src/assets - Vite will handle cache-busting
  const statesData = await import('../../../assets/data/states.json');
  const states = statesData.states as StateMeta[];

  // Load all state data files for each metric using import.meta.glob
  const fertilityFiles = import.meta.glob<StateHeatmapData>('../../../assets/data/fertility/states/*.json');
  const seasonalityFiles = import.meta.glob<StateHeatmapData>('../../../assets/data/seasonality/states/*.json');
  const conceptionFiles = import.meta.glob<StateHeatmapData>('../../../assets/data/conception/states/*.json');

  const dataFilesByMetric: Record<MetricSlug, Record<string, () => Promise<StateHeatmapData>>> = {
    fertility: fertilityFiles,
    seasonality: seasonalityFiles,
    conception: conceptionFiles,
  };

  // Generate paths for all metric × state combinations
  const paths = await Promise.all(
    METRIC_SLUGS.flatMap((metric) =>
      states.map(async (state) => {
        let stateHeatmapData: StateHeatmapData | null = null;
        const filePath = `../../../assets/data/${metric}/states/${state.code}.json`;
        const metricFiles = dataFilesByMetric[metric];

        if (metricFiles[filePath]) {
          try {
            stateHeatmapData = await metricFiles[filePath]() as StateHeatmapData;
          } catch (e) {
            console.warn(`Failed to load ${metric} data for state ${state.name}:`, e);
          }
        }

        // Transform to CountryHeatmapData format for component compatibility
        const heatmapData: CountryHeatmapData | null = stateHeatmapData
          ? stateToCountryFormat(stateHeatmapData)
          : null;

        return {
          params: { metric, state: state.code },
          props: { stateMeta: state, heatmapData, metric },
        };
      })
    )
  );

  return paths;
}

interface Props {
  stateMeta: StateMeta;
  heatmapData: CountryHeatmapData | null;
  metric: MetricSlug;
}

const { state } = Astro.params;
const { stateMeta, heatmapData, metric } = Astro.props;

const metricConfig = METRICS[metric];

// Access the metric-specific data from stateMeta
const metricData = stateMeta[metric];

function formatYearRange(range: [number, number]): string {
  return `${range[0]}–${range[1]}`;
}

// SEO metadata
const pageTitle = `${stateMeta.name} - ${metricConfig.label}`;
const pageDescription = `${metricConfig.label} data for ${stateMeta.name} from ${metricData.yearRange[0]} to ${metricData.yearRange[1]}. ${metricConfig.subtitle} Data sources: ${stateMeta.sources.join(', ')}.`;
const canonicalPath = `/${metric}/states/${state}`;

// Build full OG image URL (must be absolute for social media crawlers)
const ogImageUrl = `https://birth-heatmaps.aaronjbecker.com/og/${metric}/states/${state}.png`;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonicalPath={canonicalPath}
  ogImage={ogImageUrl}
>
  <div class="flex justify-between items-center mb-lg flex-wrap gap-sm">
    <nav class="text-sm text-text-muted">
      <a href="/" class="text-text-muted hover:text-primary">Countries</a>
      <span class="mx-1">/</span>
      <a href="/#states" class="text-text-muted hover:text-primary">US States</a>
      <span class="mx-1">/</span>
      <StateDropdown
        client:load
        states={allStates}
        currentState={state}
        metric={metric}
        variant="inline"
      />
    </nav>
    <ShareButtons
      url={`https://birth-heatmaps.aaronjbecker.com${canonicalPath}`}
      title={pageTitle}
      description={pageDescription}
    />
  </div>

  <h1 class="mb-xs">{stateMeta.name}</h1>
  <p class="text-text-muted mb-md">{metricConfig.subtitle}</p>

  <div class="flex gap-lg mb-lg text-sm text-text-muted flex-wrap items-center">
    <span>{formatYearRange(metricData.yearRange)}</span>
    <span>Sources: {stateMeta.sources.join(', ')}</span>
    <a href={`/compare?states=${state}&metric=${metric}`} class="text-primary hover:underline">
      Compare with other states →
    </a>
  </div>

  <div class="flex gap-xs mb-lg border-b border-border">
    {METRIC_SLUGS.map((m) => (
      <a
        href={`/${m}/states/${state}`}
        class:list={[
          'py-sm px-lg border-b-2 text-text-muted transition-all duration-150',
          m === metric
            ? 'border-primary text-primary'
            : 'border-transparent hover:text-text hover:no-underline'
        ]}
      >
        {METRICS[m].label}
      </a>
    ))}
  </div>

  <div class="mb-xl">
    {heatmapData ? (
      <Heatmap
        client:load
        data={heatmapData}
        height={500}
        showLegend={true}
        showYearFilter={true}
        showControls={true}
      />
    ) : (
      <div id="heatmap-container" class="min-h-[500px] flex items-center justify-center bg-bg border border-border rounded" data-state={state} data-metric={metric}>
        <p class="p-xl text-center text-text-muted">Loading heatmap data...</p>
      </div>
    )}
  </div>
</BaseLayout>

{!heatmapData && (
  <script>
    // Client-side fallback for when data isn't available at build time
    const container = document.getElementById('heatmap-container');
    const state = container?.dataset.state;
    const metric = container?.dataset.metric;

    if (state && container) {
      fetch(`/data/${metric}/states/${state}.json`)
        .then(res => {
          if (!res.ok) throw new Error('Data not found');
          return res.json();
        })
        .then(data => {
          container.innerHTML = `
            <p class="text-center p-xl">
              Heatmap data loaded: ${data.data.length} cells, ${data.years.length} years<br>
              <small class="text-text-muted">
                Note: Full D3 visualization requires data at build time.<br>
                Run the data pipeline and rebuild the site.
              </small>
            </p>
          `;
        })
        .catch(() => {
          container.innerHTML = `
            <p class="text-center p-xl text-text-muted">
              No data available for this state yet.<br>
              <small>Run the data pipeline to generate JSON files.</small>
            </p>
          `;
        });
    }
  </script>
)}
