---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EntityHeatmapPage from '../../components/EntityHeatmapPage.astro';
import CountryDropdown from '../../components/svelte/CountryDropdown.svelte';
import ShareButtons from '../../components/ShareButtons.astro';
import CountryFlag from '../../components/CountryFlag.astro';
import type { CountryMeta, CountryHeatmapData, MonthlyFertilityTimeSeriesData } from '../../lib/types';
import { METRICS, METRIC_SLUGS, type MetricSlug } from '../../lib/metrics';

// Import countries data at module level for use in page
const countriesData = await import('../../assets/data/countries.json');
const allCountries = countriesData.countries as CountryMeta[];

export async function getStaticPaths() {
  // Import countries data from src/assets - Vite will handle cache-busting
  const countriesData = await import('../../assets/data/countries.json');
  const countries = countriesData.countries as CountryMeta[];

  // Load all data files for each metric using import.meta.glob
  const fertilityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/fertility/*.json');
  const seasonalityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/seasonality/*.json');
  const conceptionFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/conception/*.json');
  const monthlyFertilityFiles = import.meta.glob<MonthlyFertilityTimeSeriesData>('../../assets/data/monthly-fertility/*.json');

  const dataFilesByMetric: Record<MetricSlug, Record<string, () => Promise<CountryHeatmapData>>> = {
    fertility: fertilityFiles,
    seasonality: seasonalityFiles,
    conception: conceptionFiles,
  };

  // Generate paths for all metric Ã— country combinations
  const paths = await Promise.all(
    METRIC_SLUGS.flatMap((metric) =>
      countries.map(async (country) => {
        let heatmapData: CountryHeatmapData | null = null;
        const filePath = `../../assets/data/${metric}/${country.code}.json`;
        const metricFiles = dataFilesByMetric[metric];

        if (metricFiles[filePath]) {
          try {
            heatmapData = await metricFiles[filePath]() as CountryHeatmapData;
          } catch (e) {
            console.warn(`Failed to load ${metric} data for ${country.name}:`, e);
          }
        }

        // Load monthly fertility timeseries data (only for fertility metric)
        let monthlyFertilityData: MonthlyFertilityTimeSeriesData | null = null;
        if (metric === 'fertility') {
          const monthlyFilePath = `../../assets/data/monthly-fertility/${country.code}.json`;
          if (monthlyFertilityFiles[monthlyFilePath]) {
            try {
              monthlyFertilityData = await monthlyFertilityFiles[monthlyFilePath]() as MonthlyFertilityTimeSeriesData;
            } catch (e) {
              console.warn(`Failed to load monthly fertility data for ${country.name}:`, e);
            }
          }
        }

        return {
          params: { metric, country: country.code },
          props: { countryMeta: country, heatmapData, monthlyFertilityData, metric },
        };
      })
    )
  );

  return paths;
}

interface Props {
  countryMeta: CountryMeta;
  heatmapData: CountryHeatmapData | null;
  monthlyFertilityData: MonthlyFertilityTimeSeriesData | null;
  metric: MetricSlug;
}

const { country } = Astro.params;
const { countryMeta, heatmapData, monthlyFertilityData, metric } = Astro.props;

const metricConfig = METRICS[metric];
const metricData = countryMeta[metric];

// SEO metadata
const pageTitle = `${countryMeta.name} - ${metricConfig.label}`;
const pageDescription = `${metricConfig.label} data for ${countryMeta.name} from ${metricData.yearRange[0]} to ${metricData.yearRange[1]}. ${metricConfig.subtitle} Data sources: ${countryMeta.sources.join(', ')}.`;
const canonicalPath = `/${metric}/${country}`;

// Build full OG image URL (must be absolute for social media crawlers)
const site = Astro.site?.origin ?? 'https://birth-heatmaps.aaronjbecker.com';
const ogImageUrl = `${site}/og/${metric}/${country}.png`;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonicalPath={canonicalPath}
  ogImage={ogImageUrl}
>
  <EntityHeatmapPage
    entityType="country"
    entityCode={country!}
    entityName={countryMeta.name}
    sources={countryMeta.sources}
    yearRange={metricData.yearRange}
    metric={metric}
    heatmapData={heatmapData}
    monthlyFertilityData={monthlyFertilityData}
    compareUrl={`/compare?countries=${country}&metric=${metric}`}
    metricBaseUrl={`/${metric}`}
    fallbackDataUrl={`/data/${metric}/${country}.json`}
  >
    <div slot="navigation" class="page-header flex justify-between items-center mb-lg flex-wrap gap-sm">
      <nav class="breadcrumb text-sm text-text-muted">
        <a href="/" class="text-text-muted hover:text-primary">Countries</a> / <CountryDropdown
          client:load
          countries={allCountries}
          currentCountry={country}
          metric={metric}
          variant="inline"
        />
      </nav>
      <ShareButtons
        url={`https://birth-heatmaps.aaronjbecker.com${canonicalPath}`}
        title={pageTitle}
        description={pageDescription}
      />
    </div>

    <h1 slot="header" class="mb-xs">
      <CountryFlag code={countryMeta.code} width={40} height={30} class="mr-sm" />
      {countryMeta.name}
    </h1>
  </EntityHeatmapPage>
</BaseLayout>
