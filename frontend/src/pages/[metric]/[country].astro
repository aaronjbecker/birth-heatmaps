---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Heatmap from '../../components/svelte/Heatmap.svelte';
import CountryDropdown from '../../components/svelte/CountryDropdown.svelte';
import ChartGallery from '../../components/ChartGallery.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import CountryFlag from '../../components/CountryFlag.astro';
import type { CountryMeta, CountryHeatmapData } from '../../lib/types';
import { METRICS, METRIC_SLUGS, type MetricSlug } from '../../lib/metrics';

// Import countries data at module level for use in page
const countriesData = await import('../../assets/data/countries.json');
const allCountries = countriesData.countries as CountryMeta[];

export async function getStaticPaths() {
  // Import countries data from src/assets - Vite will handle cache-busting
  const countriesData = await import('../../assets/data/countries.json');
  const countries = countriesData.countries as CountryMeta[];

  // Load all data files for each metric using import.meta.glob
  const fertilityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/fertility/*.json');
  const seasonalityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/seasonality/*.json');
  const conceptionFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/conception/*.json');

  const dataFilesByMetric: Record<MetricSlug, Record<string, () => Promise<CountryHeatmapData>>> = {
    fertility: fertilityFiles,
    seasonality: seasonalityFiles,
    conception: conceptionFiles,
  };

  // Generate paths for all metric × country combinations
  const paths = await Promise.all(
    METRIC_SLUGS.flatMap((metric) =>
      countries.map(async (country) => {
        let heatmapData: CountryHeatmapData | null = null;
        const filePath = `../../assets/data/${metric}/${country.code}.json`;
        const metricFiles = dataFilesByMetric[metric];

        if (metricFiles[filePath]) {
          try {
            heatmapData = await metricFiles[filePath]() as CountryHeatmapData;
          } catch (e) {
            console.warn(`Failed to load ${metric} data for ${country.name}:`, e);
          }
        }

        return {
          params: { metric, country: country.code },
          props: { countryMeta: country, heatmapData, metric },
        };
      })
    )
  );

  return paths;
}

interface Props {
  countryMeta: CountryMeta;
  heatmapData: CountryHeatmapData | null;
  metric: MetricSlug;
}

const { country } = Astro.params;
const { countryMeta, heatmapData, metric } = Astro.props;

const metricConfig = METRICS[metric];

// Access the metric-specific data from countryMeta
const metricData = countryMeta[metric];

function formatYearRange(range: [number, number]): string {
  return `${range[0]}–${range[1]}`;
}

// SEO metadata
const pageTitle = `${countryMeta.name} - ${metricConfig.label}`;
const pageDescription = `${metricConfig.label} data for ${countryMeta.name} from ${metricData.yearRange[0]} to ${metricData.yearRange[1]}. ${metricConfig.subtitle} Data sources: ${countryMeta.sources.join(', ')}.`;
const canonicalPath = `/${metric}/${country}`;

// Build full OG image URL (must be absolute for social media crawlers)
const site = Astro.site?.origin ?? 'https://birth-heatmaps.aaronjbecker.com';
const ogImageUrl = `${site}/og/${metric}/${country}.png`;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonicalPath={canonicalPath}
  ogImage={ogImageUrl}
>
  <div class="flex justify-between items-center mb-lg flex-wrap gap-sm">
    <nav class="text-sm text-text-muted">
      <a href="/" class="text-text-muted hover:text-primary">Countries</a> / <CountryDropdown
        client:load
        countries={allCountries}
        currentCountry={country}
        metric={metric}
        variant="inline"
      />
    </nav>
    <ShareButtons
      url={`https://birth-heatmaps.aaronjbecker.com${canonicalPath}`}
      title={pageTitle}
      description={pageDescription}
    />
  </div>

  <h1 class="mb-xs">
    <CountryFlag code={countryMeta.code} width={40} height={30} class="mr-sm" />
    {countryMeta.name}
  </h1>
  <p class="text-text-muted mb-md">{metricConfig.subtitle}</p>

  <div class="flex gap-lg mb-lg text-sm text-text-muted flex-wrap items-center">
    <span>{formatYearRange(metricData.yearRange)}</span>
    <span>Sources: {countryMeta.sources.join(', ')}</span>
    <a href={`/compare?countries=${country}&metric=${metric}`} class="text-primary hover:underline">
      Compare with other countries →
    </a>
  </div>

  <div class="flex gap-xs mb-lg border-b border-border">
    {METRIC_SLUGS.map((m) => (
      <a
        href={`/${m}/${country}`}
        class:list={[
          'py-sm px-lg border-b-2 text-text-muted transition-all duration-150',
          m === metric
            ? 'border-primary text-primary'
            : 'border-transparent hover:text-text hover:no-underline'
        ]}
      >
        {METRICS[m].label}
      </a>
    ))}
  </div>

  <div class="mb-xl">
    {heatmapData ? (
      <Heatmap
        client:load
        data={heatmapData}
        height={500}
        showLegend={true}
        showYearFilter={true}
        showControls={true}
      />
    ) : (
      <div id="heatmap-container" class="min-h-[500px] flex items-center justify-center bg-bg border border-border rounded" data-country={country} data-metric={metric}>
        <p class="p-xl text-center text-text-muted">Loading heatmap data...</p>
      </div>
    )}
  </div>

  <ChartGallery countrySlug={country} />
</BaseLayout>

{!heatmapData && (
  <script>
    // Client-side fallback for when data isn't available at build time
    const container = document.getElementById('heatmap-container');
    const country = container?.dataset.country;
    const metric = container?.dataset.metric;

    if (country && container) {
      fetch(`/data/${metric}/${country}.json`)
        .then(res => {
          if (!res.ok) throw new Error('Data not found');
          return res.json();
        })
        .then(data => {
          container.innerHTML = `
            <p class="text-center p-xl">
              Heatmap data loaded: ${data.data.length} cells, ${data.years.length} years<br>
              <small class="text-text-muted">
                Note: Full D3 visualization requires data at build time.<br>
                Run the data pipeline and rebuild the site.
              </small>
            </p>
          `;
        })
        .catch(() => {
          container.innerHTML = `
            <p class="text-center p-xl text-text-muted">
              No data available for this country yet.<br>
              <small>Run the data pipeline to generate JSON files.</small>
            </p>
          `;
        });
    }
  </script>
)}
