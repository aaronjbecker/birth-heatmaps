---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { HeatmapD3 } from '../../components/HeatmapD3';
import { CountryDropdown } from '../../components/CountryDropdown';
import ChartGallery from '../../components/ChartGallery.astro';
import type { CountryMeta, CountryHeatmapData } from '../../lib/types';
import { METRICS, METRIC_SLUGS, type MetricSlug } from '../../lib/metrics';

// Import countries data at module level for use in page
const countriesData = await import('../../assets/data/countries.json');
const allCountries = countriesData.countries as CountryMeta[];

export async function getStaticPaths() {
  // Import countries data from src/assets - Vite will handle cache-busting
  const countriesData = await import('../../assets/data/countries.json');
  const countries = countriesData.countries as CountryMeta[];

  // Load all data files for each metric using import.meta.glob
  const fertilityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/fertility/*.json');
  const seasonalityFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/seasonality/*.json');
  const conceptionFiles = import.meta.glob<CountryHeatmapData>('../../assets/data/conception/*.json');

  const dataFilesByMetric: Record<MetricSlug, Record<string, () => Promise<CountryHeatmapData>>> = {
    fertility: fertilityFiles,
    seasonality: seasonalityFiles,
    conception: conceptionFiles,
  };

  // Generate paths for all metric × country combinations
  const paths = await Promise.all(
    METRIC_SLUGS.flatMap((metric) =>
      countries.map(async (country) => {
        let heatmapData: CountryHeatmapData | null = null;
        const filePath = `../../assets/data/${metric}/${country.code}.json`;
        const metricFiles = dataFilesByMetric[metric];

        if (metricFiles[filePath]) {
          try {
            heatmapData = await metricFiles[filePath]() as CountryHeatmapData;
          } catch (e) {
            console.warn(`Failed to load ${metric} data for ${country.name}:`, e);
          }
        }

        return {
          params: { metric, country: country.code },
          props: { countryMeta: country, heatmapData, metric },
        };
      })
    )
  );

  return paths;
}

interface Props {
  countryMeta: CountryMeta;
  heatmapData: CountryHeatmapData | null;
  metric: MetricSlug;
}

const { country } = Astro.params;
const { countryMeta, heatmapData, metric } = Astro.props;

const metricConfig = METRICS[metric];

// Access the metric-specific data from countryMeta
const metricData = countryMeta[metric];

function formatYearRange(range: [number, number]): string {
  return `${range[0]}–${range[1]}`;
}
---

<BaseLayout title={`${countryMeta.name} - ${metricConfig.label}`}>
  <nav class="breadcrumb">
    <a href="/">Countries</a> / <CountryDropdown
      client:load
      countries={allCountries}
      currentCountry={country}
      metric={metric}
      variant="inline"
    />
  </nav>

  <h1>{countryMeta.name}</h1>
  <p class="subtitle">{metricConfig.subtitle}</p>

  <div class="meta">
    <span class="year-range">{formatYearRange(metricData.yearRange)}</span>
    <span class="sources">Sources: {countryMeta.sources.join(', ')}</span>
  </div>

  <div class="tabs">
    {METRIC_SLUGS.map((m) => (
      <a
        href={`/${m}/${country}`}
        class:list={['tab', { active: m === metric }]}
      >
        {METRICS[m].label}
      </a>
    ))}
  </div>

  <div class="heatmap-wrapper">
    {heatmapData ? (
      <HeatmapD3
        client:load
        data={heatmapData}
        height={500}
        showLegend={true}
        showYearFilter={true}
        showControls={true}
      />
    ) : (
      <div id="heatmap-container" class="heatmap-container" data-country={country} data-metric={metric}>
        <p class="loading">Loading heatmap data...</p>
      </div>
    )}
  </div>

  <ChartGallery countrySlug={country} />
</BaseLayout>

<style>
  .breadcrumb {
    margin-bottom: var(--space-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .breadcrumb a {
    color: var(--color-text-muted);
  }

  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  h1 {
    margin-bottom: var(--space-xs);
  }

  .subtitle {
    color: var(--color-text-muted);
    margin-bottom: var(--space-md);
  }

  .meta {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .tab {
    padding: var(--space-sm) var(--space-lg);
    border-bottom: 2px solid transparent;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.15s, border-color 0.15s;
  }

  .tab:hover {
    color: var(--color-text);
    text-decoration: none;
  }

  .tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .heatmap-wrapper {
    margin-bottom: var(--space-xl);
  }

  .heatmap-container {
    min-height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fafafa;
    border: 1px solid var(--color-border);
    border-radius: 4px;
  }

  .loading {
    padding: var(--space-xl);
    text-align: center;
    color: var(--color-text-muted);
  }
</style>

{!heatmapData && (
  <script>
    // Client-side fallback for when data isn't available at build time
    const container = document.getElementById('heatmap-container');
    const country = container?.dataset.country;
    const metric = container?.dataset.metric;

    if (country && container) {
      fetch(`/data/${metric}/${country}.json`)
        .then(res => {
          if (!res.ok) throw new Error('Data not found');
          return res.json();
        })
        .then(data => {
          container.innerHTML = `
            <p style="text-align: center; padding: var(--space-xl);">
              Heatmap data loaded: ${data.data.length} cells, ${data.years.length} years<br>
              <small style="color: var(--color-text-muted);">
                Note: Full D3 visualization requires data at build time.<br>
                Run the data pipeline and rebuild the site.
              </small>
            </p>
          `;
        })
        .catch(() => {
          container.innerHTML = `
            <p style="text-align: center; padding: var(--space-xl); color: var(--color-text-muted);">
              No data available for this country yet.<br>
              <small>Run the data pipeline to generate JSON files.</small>
            </p>
          `;
        });
    }
  </script>
)}
