---
import BaseLayout from '../layouts/BaseLayout.astro';
import { CountryDropdown } from '../components/CountryDropdown';
import Heatmap from '../components/svelte/Heatmap.svelte';
import type { CountryMeta, CountryHeatmapData } from '../lib/types';
import { METRICS } from '../lib/metrics';

// Import countries data from src/assets - Vite will handle cache-busting
import countriesData from '../assets/data/countries.json';

// Import US fertility data for demo heatmap
import usaFertilityData from '../assets/data/fertility/united-states-of-america.json';

const countries = (countriesData.countries || []) as CountryMeta[];
const demoData = usaFertilityData as CountryHeatmapData;

function formatYearRange(range: [number, number]): string {
  return `${range[0]}–${range[1]}`;
}
---

<BaseLayout
  title="Countries"
  description={`Explore fertility rates and birth seasonality patterns across ${countries.length} countries. Data from the Human Mortality Database and UN Population Division.`}
  canonicalPath="/"
>
  <h1 class="mb-sm">Birth Seasonality Heatmaps</h1>
  <p class="mb-lg text-text-muted">
    Explore fertility rates and birth seasonality patterns across {countries.length} countries.
    Data from the Human Mortality Database, UN Population Division, and country-specific sources.
  </p>

  <div class="mb-xl p-lg bg-card-bg border border-card-border rounded-lg">
    <div class="flex justify-between items-center mb-md">
      <h2 class="m-0 text-xl">United States of America</h2>
      <a href="/fertility/united-states-of-america" class="text-sm text-primary hover:underline">View full page →</a>
    </div>
    <p class="text-text-muted mb-md mt-0">{METRICS.fertility.subtitle}</p>

    <Heatmap
      client:load
      data={demoData}
      height={400}
      showLegend={true}
      showYearFilter={true}
      showControls={true}
    />
  </div>

  <div class="mb-xl flex justify-center">
    <CountryDropdown
      client:load
      countries={countries}
      metric="fertility"
    />
  </div>

  {countries.length > 0 ? (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-lg">
      {countries.map((country) => (
        <a href={`/fertility/${country.code}`} class="block p-lg bg-card-bg border border-card-border rounded-lg hover:border-primary transition-colors">
          <h3 class="text-lg font-semibold mb-sm">{country.name}</h3>
          <p class="text-sm text-text-muted mb-xs">
            Sources: {country.sources.join(', ')}
          </p>
          <p class="text-sm text-text-muted">
            {formatYearRange(country.fertility.yearRange)} · {country.completeYears} complete years
          </p>
        </a>
      ))}
    </div>
  ) : (
    <div class="p-lg bg-card-bg border border-card-border rounded-lg">
      <h2 class="mb-md">No Data Available</h2>
      <p class="mb-md">
        Run the data pipeline to generate country data:
      </p>
      <pre class="bg-bg p-md rounded overflow-x-auto">
python data-pipeline/scripts/run_pipeline.py --json
      </pre>
    </div>
  )}
</BaseLayout>
