---
/**
 * Astro wrapper component for the D3 heatmap
 * This component handles data loading at build time and hydrates the React component
 */
import { HeatmapD3 } from './HeatmapD3';
import type { CountryHeatmapData } from '../lib/types';

interface Props {
  data?: CountryHeatmapData;
  dataUrl?: string;
  height?: number;
  showLegend?: boolean;
  showYearFilter?: boolean;
  showControls?: boolean;
}

const {
  data,
  dataUrl,
  height = 500,
  showLegend = true,
  showYearFilter = true,
  showControls = true,
} = Astro.props;
---

{data ? (
  <HeatmapD3
    client:load
    data={data}
    height={height}
    showLegend={showLegend}
    showYearFilter={showYearFilter}
    showControls={showControls}
  />
) : dataUrl ? (
  <div class="min-h-[400px] flex items-center justify-center bg-bg border border-dashed border-border rounded" data-url={dataUrl} data-height={height}>
    <p class="text-text-muted text-sm">Loading heatmap...</p>
  </div>
  <script define:vars={{ height, showLegend, showYearFilter, showControls }}>
    // Client-side data loading for dynamic routes
    document.addEventListener('DOMContentLoaded', async () => {
      const loaders = document.querySelectorAll('[data-url]');

      for (const loader of loaders) {
        const url = loader.dataset.url;
        if (!url) continue;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Failed to load: ${response.statusText}`);
          }
          const data = await response.json();

          // Create React root and render HeatmapD3
          // Note: This requires the React component to be available globally
          // For full client-side loading, use the dataUrl approach with a script
          loader.innerHTML = `
            <div style="min-height: ${height}px;">
              <p class="text-center p-lg text-text-muted">
                Heatmap data loaded: ${data.data.length} cells
              </p>
            </div>
          `;
        } catch (error) {
          loader.innerHTML = `
            <p class="text-center p-lg text-red-600">
              Error loading heatmap data
            </p>
          `;
        }
      }
    });
  </script>
) : (
  <div class="min-h-[400px] flex items-center justify-center bg-bg border border-dashed border-border rounded">
    <p class="text-text-muted text-sm">No data provided. Pass either 'data' or 'dataUrl' prop.</p>
  </div>
)}
