---
/**
 * ChartImage component for displaying optimized chart images.
 *
 * Uses Astro's Image component for optimization when images are available,
 * with graceful fallback when charts haven't been generated yet.
 */
import { Image } from 'astro:assets';
import { CHART_METADATA, type ChartType, getChartFilename } from '../lib/chart-config';

export interface Props {
  countrySlug: string;
  chartType: ChartType;
  class?: string;
}

const { countrySlug, chartType, class: className } = Astro.props;

const metadata = CHART_METADATA[chartType];
const filename = getChartFilename(chartType);

// Try to dynamically import the chart image
let chartImage: ImageMetadata | null = null;

try {
  // Use Vite's glob import to get all chart images
  const images = import.meta.glob<{ default: ImageMetadata }>(
    '../assets/charts/**/*.png',
    { eager: true }
  );

  const imagePath = `../assets/charts/${countrySlug}/${filename}`;
  if (images[imagePath]) {
    chartImage = images[imagePath].default;
  }
} catch {
  // Image not available, chartImage remains null
}
---

<figure class:list={['chart-image', 'm-0 mb-xl', className]}>
  <figcaption class="mb-sm">
    <h3 class="m-0 mb-xs text-lg font-semibold text-text">{metadata.label}</h3>
    <p class="m-0 text-sm text-text-muted">{metadata.description}</p>
  </figcaption>

  <div class="bg-bg border border-border rounded overflow-hidden">
    {chartImage ? (
      <a
        href={chartImage.src}
        data-pswp-width={chartImage.width}
        data-pswp-height={chartImage.height}
        class="lightbox-trigger block cursor-zoom-in no-underline focus-visible:outline-2 focus-visible:outline-primary focus-visible:outline-offset-2"
        aria-label={`View full size: ${metadata.label}`}
      >
        <Image
          src={chartImage}
          alt={`${metadata.label} for ${countrySlug}`}
          width={800}
          quality={85}
          loading="lazy"
          class="w-full h-auto block transition-transform duration-200 ease-in-out hover:scale-[1.02] focus-visible:rounded"
        />
      </a>
    ) : (
      <div class="p-xl text-center text-text-muted min-h-[200px] flex flex-col items-center justify-center">
        <p class="m-0 mb-xs">Chart not available</p>
        <small class="text-xs opacity-70">Run the data pipeline to generate charts</small>
      </div>
    )}
  </div>
</figure>
