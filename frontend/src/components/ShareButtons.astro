---
import { Icon } from 'astro-icon/components';

interface Props {
  url: string;
  title: string;
  description?: string;
}

const { url, title, description = '' } = Astro.props;

// Encode parameters for URLs
const encodedUrl = encodeURIComponent(url);
const encodedTitle = encodeURIComponent(title);
const encodedDescription = encodeURIComponent(description);

// Share URLs for each platform
const shareLinks = {
  x: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
  bluesky: `https://bsky.app/intent/compose?text=${encodedTitle}%20${encodedUrl}`,
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
  reddit: `https://www.reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
  email: `mailto:?subject=${encodedTitle}&body=${encodedDescription}%0A%0A${encodedUrl}`,
};
---

<div class="share-buttons flex gap-xs items-center md:gap-sm">
  <a
    href={shareLinks.x}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Share on X"
    title="Share on X"
  >
    <Icon name="simple-icons:x" class="w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </a>

  <a
    href={shareLinks.bluesky}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Share on Bluesky"
    title="Share on Bluesky"
  >
    <Icon name="simple-icons:bluesky" class="w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </a>

  <a
    href={shareLinks.facebook}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Share on Facebook"
    title="Share on Facebook"
  >
    <Icon name="simple-icons:facebook" class="w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </a>

  <a
    href={shareLinks.reddit}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Share on Reddit"
    title="Share on Reddit"
  >
    <Icon name="simple-icons:reddit" class="w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </a>

  <a
    href={shareLinks.email}
    class="share-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Share via email"
    title="Share via email"
  >
    <Icon name="mdi:email-outline" class="w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </a>

  <button
    type="button"
    class="share-btn copy-link-btn flex items-center justify-center w-8 h-8 md:w-10 md:h-10 p-0 border border-border rounded-md bg-bg-alt text-text-muted cursor-pointer no-underline transition-all duration-200 hover:text-text hover:border-primary hover:scale-105 hover:no-underline focus:outline-none focus:border-primary focus:shadow-[0_0_0_2px_rgba(37,99,235,0.2)] active:scale-95"
    aria-label="Copy link"
    title="Copy link"
    data-url={url}
  >
    <Icon name="mdi:link-variant" class="icon-link w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
    <Icon name="mdi:check" class="icon-check hidden text-green-500 w-[18px] h-[18px] md:w-[22px] md:h-[22px]" />
  </button>
</div>

<style>
  /* Icon visibility toggle for copy button */
  .copy-link-btn.copied .icon-link {
    display: none;
  }

  .copy-link-btn.copied .icon-check {
    display: block;
  }
</style>

<script>
  function initCopyButtons() {
    const copyButtons = document.querySelectorAll('.copy-link-btn');

    copyButtons.forEach((btn) => {
      // Avoid adding multiple listeners
      if (btn.hasAttribute('data-copy-initialized')) return;
      btn.setAttribute('data-copy-initialized', 'true');

      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url');
        if (!url) return;

        try {
          await navigator.clipboard.writeText(url);
          btn.classList.add('copied');

          setTimeout(() => {
            btn.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy link:', err);
        }
      });
    });
  }

  // Run on initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCopyButtons);
  } else {
    initCopyButtons();
  }

  // Run on Astro client-side navigation
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
