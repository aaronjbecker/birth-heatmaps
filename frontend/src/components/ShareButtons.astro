---
import { Icon } from 'astro-icon/components';

interface Props {
  url: string;
  title: string;
  description?: string;
}

const { url, title, description = '' } = Astro.props;

// Encode parameters for URLs
const encodedUrl = encodeURIComponent(url);
const encodedTitle = encodeURIComponent(title);
const encodedDescription = encodeURIComponent(description);

// Share URLs for each platform
const shareLinks = {
  x: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
  bluesky: `https://bsky.app/intent/compose?text=${encodedTitle}%20${encodedUrl}`,
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
  reddit: `https://www.reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
  email: `mailto:?subject=${encodedTitle}&body=${encodedDescription}%0A%0A${encodedUrl}`,
};
---

<div class="share-buttons">
  <a
    href={shareLinks.x}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn"
    aria-label="Share on X"
    title="Share on X"
  >
    <Icon name="simple-icons:x" />
  </a>

  <a
    href={shareLinks.bluesky}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn"
    aria-label="Share on Bluesky"
    title="Share on Bluesky"
  >
    <Icon name="simple-icons:bluesky" />
  </a>

  <a
    href={shareLinks.facebook}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn"
    aria-label="Share on Facebook"
    title="Share on Facebook"
  >
    <Icon name="simple-icons:facebook" />
  </a>

  <a
    href={shareLinks.reddit}
    target="_blank"
    rel="noopener noreferrer"
    class="share-btn"
    aria-label="Share on Reddit"
    title="Share on Reddit"
  >
    <Icon name="simple-icons:reddit" />
  </a>

  <a
    href={shareLinks.email}
    class="share-btn"
    aria-label="Share via email"
    title="Share via email"
  >
    <Icon name="mdi:email-outline" />
  </a>

  <button
    type="button"
    class="share-btn copy-link-btn"
    aria-label="Copy link"
    title="Copy link"
    data-url={url}
  >
    <Icon name="mdi:link-variant" class="icon-link" />
    <Icon name="mdi:check" class="icon-check" />
  </button>
</div>

<style>
  .share-buttons {
    display: flex;
    gap: var(--space-xs);
    align-items: center;
  }

  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .share-btn:hover {
    color: var(--color-text);
    border-color: var(--color-primary);
    transform: scale(1.05);
    text-decoration: none;
  }

  .share-btn:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
  }

  .share-btn:active {
    transform: scale(0.95);
  }

  .share-btn [data-icon] {
    width: 18px;
    height: 18px;
  }

  .copy-link-btn .icon-check {
    display: none;
    color: #22c55e;
  }

  .copy-link-btn.copied .icon-link {
    display: none;
  }

  .copy-link-btn.copied .icon-check {
    display: block;
  }

  /* Desktop styles */
  @media (min-width: 768px) {
    .share-buttons {
      gap: var(--space-sm);
    }

    .share-btn {
      width: 40px;
      height: 40px;
    }

    .share-btn [data-icon] {
      width: 22px;
      height: 22px;
    }
  }
</style>

<script>
  function initCopyButtons() {
    const copyButtons = document.querySelectorAll('.copy-link-btn');

    copyButtons.forEach((btn) => {
      // Avoid adding multiple listeners
      if (btn.hasAttribute('data-copy-initialized')) return;
      btn.setAttribute('data-copy-initialized', 'true');

      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url');
        if (!url) return;

        try {
          await navigator.clipboard.writeText(url);
          btn.classList.add('copied');

          setTimeout(() => {
            btn.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy link:', err);
        }
      });
    });
  }

  // Run on initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCopyButtons);
  } else {
    initCopyButtons();
  }

  // Run on Astro client-side navigation
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
