---
/**
 * ChartGallery component for displaying all charts for a country.
 *
 * Organizes charts into logical sections:
 * - Heatmaps (fertility and seasonality)
 * - Time series (population, births, fertility rate)
 * - Distributions (monthly boxplot, monthly trends)
 */
import ChartImage from './ChartImage.astro';
import { type ChartType } from '../lib/chart-config';

export interface Props {
  countrySlug: string;
}

const { countrySlug } = Astro.props;

interface ChartSection {
  title: string;
  description: string;
  charts: ChartType[];
}

const sections: ChartSection[] = [
  {
    title: 'Heatmap Visualizations',
    description: 'Monthly patterns across years shown as heatmaps',
    charts: ['fertility_heatmap', 'seasonality_heatmap'],
  },
  {
    title: 'Monthly Patterns',
    description: 'Analysis of which months have higher or lower birth rates',
    charts: ['monthly_fertility_chart', 'monthly_fertility_boxplot'],
  },
  {
    title: 'Time Series',
    description: 'Long-term trends in population, births, and fertility',
    charts: ['births_chart', 'daily_fertility_rate_chart', 'population_chart',],
  },
];
---

<div class="mt-xl">
  {sections.map((section, index) => (
    <section class="mb-2xl">
      <header class="mb-lg pb-sm border-b border-border">
        <h2 class="m-0 mb-xs text-2xl font-semibold text-text">{section.title}</h2>
        <p class="m-0 text-text-muted text-[0.9375rem]">{section.description}</p>
      </header>

      <div class:list={[
        'grid gap-lg',
        index === 0 ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-2'
      ]}>
        {section.charts.map((chartType) => (
          <ChartImage
            countrySlug={countrySlug}
            chartType={chartType}
          />
        ))}
      </div>
    </section>
  ))}
</div>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import PhotoSwipe from 'photoswipe';
  import 'photoswipe/style.css';

  let lightbox: PhotoSwipeLightbox | null = null;

  function initPhotoSwipe() {
    // Destroy previous instance if exists
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }

    // Get the chart gallery container
    const gallery = document.querySelector('.chart-gallery');
    if (!gallery) return;

    // Initialize PhotoSwipe
    lightbox = new PhotoSwipeLightbox({
      gallery: '.chart-gallery',
      children: '.lightbox-trigger',
      pswpModule: PhotoSwipe,
      // UI configuration - no padding to maximize viewport usage
      padding: { top: 0, bottom: 0, left: 0, right: 0 },
      bgOpacity: 1,
      // Enable zoom
      zoom: true,
      maxZoomLevel: 3,
      // Enable closing on background click
      closeOnVerticalDrag: true,
      // Keyboard navigation
      escKey: true,
      arrowKeys: true,
      // Enable looping
      loop: true,
    });

    lightbox.init();
  }

  // Initialize on first load
  initPhotoSwipe();

  // Re-initialize on Astro view transitions (for single-page navigation)
  document.addEventListener('astro:page-load', initPhotoSwipe);

  // Cleanup on page unload
  document.addEventListener('astro:before-swap', () => {
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }
  });
</script>
