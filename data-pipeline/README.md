# Data Pipeline

This directory contains the Python data processing pipeline that prepares birth and population data for the frontend visualization.

## Quick Start

### Development Entry Point

For local development, use the **"Python: Run Pipeline (JSON + Charts)"** configuration in VSCode, which runs:

```bash
python scripts/run_pipeline.py --json --charts
```

This generates all outputs needed for frontend development.

### Docker Entry Point

```bash
# Run the full pipeline
docker compose run pipeline

# Or run just JSON exports (faster, no charts)
docker compose run pipeline-json
```

## Pipeline Outputs

The pipeline generates the following outputs:

### 1. JSON Data Files (Required for Frontend)

**Location:**
- `output/` - Pipeline output directory
- `../frontend/src/assets/data/` - Frontend assets (used by Vite imports)

**Files:**
- `countries.json` - List of all countries with metadata
- `fertility/{country}.json` - Fertility rate data per country
- `seasonality/{country}.json` - Seasonality data per country

**Usage:** These files are imported directly by the Astro/Vite frontend:
```typescript
import countriesData from '../assets/data/countries.json';
const files = import.meta.glob('../../assets/data/fertility/*.json');
```

### 2. Chart Images (Optional, for Supplementary Analysis)

**Locations:**
- `output/charts/{country-slug}/` - Pipeline output (for archival)
- `../frontend/src/content/charts/{country-slug}/` - Frontend assets (for display)

**Files per country:**
- `fertility_heatmap.png` - Fertility rate heatmap
- `seasonality_heatmap.png` - Seasonality heatmap
- `monthly_fertility_chart.png` - Monthly fertility trends
- `monthly_fertility_boxplot.png` - Monthly fertility distribution
- `population_chart.png` - Childbearing population over time
- `births_chart.png` - Total monthly births
- `daily_fertility_rate_chart.png` - Daily fertility rate time series

**Usage:**
- These PNG charts are generated by matplotlib for supplementary analysis
- They are **automatically copied** to the frontend during pipeline execution
- The frontend displays them using Astro's `<Image>` component with Vite optimization
- Primary visualizations are D3 interactive heatmaps (rendered from JSON data)

**Loading:** Charts are imported in the frontend using `import.meta.glob()` for optimized asset handling. See [CHART_LOADING.md](../CHART_LOADING.md) for details.

### 3. CSV Files (Legacy, Not Used)

**Location:** `src/` (legacy location)

**Files:**
- `births_heatmap_data.csv`
- `population_heatmap_data.csv`
- `stats_heatmap_data.csv`

**Status:** CSV export is available via `--csv` or `--all` flags for backwards compatibility, but **these files are not used anywhere in the current application**. The old scripts `prepare_heatmap_data.py` and `build_fertility_charts.py` that used CSVs have been superseded by the new modular pipeline.

## Command Line Options

```bash
# JSON only (fastest, for frontend development)
python scripts/run_pipeline.py --json

# Charts only
python scripts/run_pipeline.py --charts

# JSON + Charts (recommended for development)
python scripts/run_pipeline.py --json --charts

# Everything including legacy CSV files
python scripts/run_pipeline.py --all

# Custom data directories
python scripts/run_pipeline.py --json --charts \
  --hmd-dir /path/to/hmd \
  --un-dir /path/to/un
```

## Pipeline Architecture

```
scripts/run_pipeline.py          # Main entry point
├── loaders/                     # Data loading from HMD, UN, Japan
│   ├── hmd.py                  # Human Mortality Database
│   ├── un.py                   # UN World Population Prospects
│   └── japan.py                # Japan population data
├── processors/                  # Data transformation
│   ├── interpolation.py        # Population interpolation
│   ├── fertility.py            # Fertility rate computation
│   └── seasonality.py          # Seasonality metrics
├── exporters/                   # Output generation
│   ├── json_exporter.py        # JSON files for frontend
│   └── chart_exporter.py       # PNG charts
├── schemas/                     # Data validation
│   └── pandera_schemas.py      # Pandera schema definitions
└── config/                      # Settings
    ├── settings.py             # Paths and constants
    └── countries.py            # Country metadata
```

## Data Flow

```
┌─────────────────┐
│  Raw Data       │
│  - HMD          │──┐
│  - UN           │  │
│  - Japan        │  │
└─────────────────┘  │
                     │ loaders/
                     ▼
┌─────────────────┐
│ Combined Data   │
│ - Births        │
│ - Population    │
└─────────────────┘
                     │ processors/
                     ▼
┌─────────────────┐
│ Processed Data  │
│ - Fertility     │
│ - Seasonality   │
└─────────────────┘
                     │ exporters/
                     ▼
┌─────────────────┬─────────────────┐
│  JSON Files     │  Chart Images   │
│  (Frontend)     │  (Docs)         │
└─────────────────┴─────────────────┘
```

## Output Directory Structure

```
output/
├── countries.json              # Country metadata
├── fertility/                  # Per-country fertility data
│   ├── USA.json
│   ├── JPN.json
│   └── ...
├── seasonality/                # Per-country seasonality data
│   ├── USA.json
│   ├── JPN.json
│   └── ...
└── charts/                     # PNG visualizations (optional)
    ├── USA_fertility.png
    ├── USA_seasonality.png
    └── ...
```

The JSON files are also copied to `../frontend/src/assets/data/` for Vite imports.

## Environment Variables

- `HMD_DATA_DIR` - Path to HMD data directory (default: `./hmd_data`)
- `UN_DATA_DIR` - Path to UN data directory (default: `./data`)
- `OUTPUT_DIR` - Pipeline output directory (default: `./output`)
- `FRONTEND_ASSETS_DATA_DIR` - Frontend assets directory (default: `../frontend/src/assets/data`)

These are configured in [.vscode/launch.json](../.vscode/launch.json) for local development and in [docker-compose.yml](../docker-compose.yml) for Docker.

## Testing

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src

# Run specific test
pytest tests/test_exporters.py
```

## Metrics Computed

The pipeline computes several fertility and seasonality metrics:

- **Daily Fertility Rate (DFR)**: Births per day per 100,000 women aged 15-44
- **12-Month Moving Average**: Smoothed fertility trend
- **Seasonality Ratio (12-month)**: DFR / 12-month moving average
- **Seasonality Ratio (Annual)**: Percentage of annual births per month (normalized to 30-day months)

See [../README.md](../README.md) for more details on the metrics.
