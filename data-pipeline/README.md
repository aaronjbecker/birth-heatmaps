# Data Pipeline

This directory contains the Python data processing pipeline that prepares birth and population data for the frontend visualization.

## Quick Start

### Development Entry Point

For local development, use the **"Python: Run Pipeline (JSON + Charts)"** configuration in VSCode, which runs:

```bash
python scripts/run_pipeline.py --json --charts
```

This generates all outputs needed for frontend development.

### Docker Entry Point

```bash
# Run the full pipeline
docker compose run pipeline

# Or run just JSON exports (faster, no charts)
docker compose run pipeline-json
```

## Pipeline Outputs

The pipeline generates the following outputs:

### 1. JSON Data Files (Required for Frontend)

**Location:**
- `output/` - Pipeline output directory
- `../frontend/src/assets/data/` - Frontend assets (used by Vite imports)

**Files:**
- `countries.json` - List of all countries with metadata
- `fertility/{country}.json` - Fertility rate data per country
- `seasonality/{country}.json` - Seasonality data per country

**Color Scale Calculation:**
- Color scales are calculated dynamically from the actual data values in each country's dataset
- Only non-null values are used for color scale domain calculation (provisional data excluded)
- **Fertility**: Sequential scale with domain `[min, max]` computed from `daily_fertility_rate` values
- **Seasonality**: Diverging scale with domain `[min, center, max]` computed from `seasonality_percentage_normalized` values
  - Center point is 0.0833 (1/12, representing equal monthly distribution)
  - Ensures the color scale accurately reflects the actual data range, excluding any filtered provisional data

**Usage:** These files are imported directly by the Astro/Vite frontend:
```typescript
import countriesData from '../assets/data/countries.json';
const files = import.meta.glob('../../assets/data/fertility/*.json');
```

### 2. Chart Images (Optional, for Supplementary Analysis)

**Locations:**
- `output/charts/{country-slug}/` - Pipeline output (for archival)
- `../frontend/src/assets/charts/{country-slug}/` - Frontend assets (for display)

**Files per country:**
- `fertility_heatmap.png` - Fertility rate heatmap
- `seasonality_heatmap.png` - Seasonality heatmap
- `monthly_fertility_chart.png` - Monthly fertility trends
- `monthly_fertility_boxplot.png` - Monthly fertility distribution
- `population_chart.png` - Childbearing population over time
- `births_chart.png` - Total monthly births
- `daily_fertility_rate_chart.png` - Daily fertility rate time series

**Usage:**
- These PNG charts are generated by matplotlib for supplementary analysis
- They are **automatically copied** to the frontend during pipeline execution
- The frontend displays them using Astro's `<Image>` component with Vite optimization
- Primary visualizations are D3 interactive heatmaps (rendered from JSON data)

**Loading:** Charts are imported in the frontend using `import.meta.glob()` for optimized asset handling. See [CHART_LOADING.md](../CHART_LOADING.md) for details.

### 3. CSV Files (Legacy, Not Used)

**Location:** `src/` (legacy location)

**Files:**
- `births_heatmap_data.csv`
- `population_heatmap_data.csv`
- `stats_heatmap_data.csv`

**Status:** CSV export is available via `--csv` or `--all` flags for backwards compatibility, but **these files are not used anywhere in the current application**. The old scripts `prepare_heatmap_data.py` and `build_fertility_charts.py` that used CSVs have been superseded by the new modular pipeline.

## Command Line Options

```bash
# JSON only (fastest, for frontend development)
python scripts/run_pipeline.py --json

# Charts only
python scripts/run_pipeline.py --charts

# JSON + Charts (recommended for development)
python scripts/run_pipeline.py --json --charts

# Everything including legacy CSV files
python scripts/run_pipeline.py --all

# Custom data directories
python scripts/run_pipeline.py --json --charts \
  --hmd-dir /path/to/hmd \
  --un-dir /path/to/un
```

## Pipeline Architecture

```
scripts/run_pipeline.py          # Main entry point
├── loaders/                     # Data loading from HMD, UN, Japan
│   ├── hmd.py                  # Human Mortality Database
│   ├── un.py                   # UN World Population Prospects
│   └── japan.py                # Japan population data
├── processors/                  # Data transformation
│   ├── interpolation.py        # Population interpolation
│   ├── fertility.py            # Fertility rate computation
│   └── seasonality.py          # Seasonality metrics
├── exporters/                   # Output generation
│   ├── json_exporter.py        # JSON files for frontend
│   └── chart_exporter.py       # PNG charts
├── schemas/                     # Data validation
│   └── pandera_schemas.py      # Pandera schema definitions
└── config/                      # Settings
    ├── settings.py             # Paths and constants
    └── countries.py            # Country metadata
```

## Data Flow

```
┌─────────────────┐
│  Raw Data       │
│  - HMD          │──┐
│  - UN           │  │
│  - Japan        │  │
└─────────────────┘  │
                     │ loaders/
                     ▼
┌─────────────────┐
│ Combined Data   │
│ - Births        │
│ - Population    │
└─────────────────┘
                     │ processors/
                     ▼
┌─────────────────┐
│ Processed Data  │
│ - Fertility     │
│ - Seasonality   │
└─────────────────┘
                     │ exporters/
                     ▼
┌─────────────────┬─────────────────┐
│  JSON Files     │  Chart Images   │
│  (Frontend)     │  (Docs)         │
└─────────────────┴─────────────────┘
```

## Output Directory Structure

```
output/
├── countries.json              # Country metadata
├── fertility/                  # Per-country fertility data
│   ├── USA.json
│   ├── JPN.json
│   └── ...
├── seasonality/                # Per-country seasonality data
│   ├── USA.json
│   ├── JPN.json
│   └── ...
└── charts/                     # PNG visualizations (optional)
    ├── USA_fertility.png
    ├── USA_seasonality.png
    └── ...
```

The JSON files are also copied to `../frontend/src/assets/data/` for Vite imports.

## Raw Data Setup

Raw data files are **not included** in the repository per license terms (except for Japan population data, see below). You must download them manually.

### Summary of Required Files

| File | Source | Location | Tracked by Git |
|------|--------|----------|----------------|
| `jpop.csv` | fmsb R package | `data-pipeline/jpop.csv` | **Yes** |
| `{COUNTRY}birthbymonth.txt` | HMD | `data/hmd_countries_YYYYMMDD/{COUNTRY}/InputDB/` | No |
| `{COUNTRY}pop.txt` | HMD | `data/hmd_countries_YYYYMMDD/{COUNTRY}/InputDB/` | No |
| `un_births_by_month_data_raw.csv` | UN Data | `data/` | No |
| `WPP2024_PopulationBySingleAgeSex_Medium_1950-2023.csv` | UN WPP | `data/` | No |

### Human Mortality Database (HMD)

**Source:** https://www.mortality.org/ (registration required)

**Files Used Per Country:**
- `{COUNTRY_CODE}birthbymonth.txt` - Monthly births data (columns: Year, Month, Births, LDB, etc.)
- `{COUNTRY_CODE}pop.txt` - Population by age and sex (columns: Year, Month, Sex, Age, Population, LDB, etc.)

**HMD Country Codes:** The pipeline expects data for these country codes:
`AUS`, `AUT`, `BEL`, `BLR`, `BGR`, `CAN`, `CHE`, `CHL`, `CZE`, `DEUTE`, `DEUTNP`, `DEUTW`, `DNK`, `ESP`, `EST`, `FIN`, `FRATNP`, `GBR_NIR`, `GBRTENW`, `GBR_NP`, `GBR_SCO`, `GRC`, `HKG`, `HRV`, `HUN`, `IRL`, `ISL`, `ISR`, `ITA`, `JPN`, `KOR`, `LTU`, `LUX`, `LVA`, `NLD`, `NOR`, `NZL_NP`, `POL`, `PRT`, `RUS`, `SVK`, `SVN`, `SWE`, `UKR`, `USA`

**Bulk Download (Recommended):**

1. Register at https://www.mortality.org/
2. Download the bulk data ZIP (e.g., `hmd_countries_20241115.zip`)
3. Extract to `data/` at the repository root:
   ```
   birth-heatmaps/
   ├── data/
   │   └── hmd_countries_YYYYMMDD/    # Extracted bulk download
   │       ├── USA/
   │       │   ├── InputDB/
   │       │   │   ├── USAbirthbymonth.txt    # ← Used by pipeline
   │       │   │   ├── USApop.txt             # ← Used by pipeline
   │       │   │   └── ...
   │       │   └── STATS/
   │       │       └── ...
   │       ├── JPN/
   │       └── ...
   ├── data-pipeline/
   └── frontend/
   ```

The pipeline automatically detects the latest `hmd_countries_YYYYMMDD` directory by date.

**Legacy Flat File Structure:**

If no bulk download is found, the pipeline falls back to `hmd_data/` at the repository root:
```
birth-heatmaps/
├── hmd_data/
│   ├── USAbirthbymonth.txt
│   ├── USApop.txt
│   ├── JPNbirthbymonth.txt
│   ├── JPNpop.txt
│   └── ...
```

### UN Data

**1. UN Births by Month**

**Source:** https://data.un.org/Data.aspx?d=POP&f=tableCode%3A55

**File:** `data/un_births_by_month_data_raw.csv`

**Setup:**
1. Download from the UN Data website (select all countries/years)
2. Extract and rename to `un_births_by_month_data_raw.csv`
3. Place in `data/` at repository root

**Expected Columns:** `Country or Area`, `Year`, `Month`, `Value`, `Reliability`, etc.

**2. World Population Prospects (WPP)**

**Source:** https://population.un.org/wpp/downloads

**File:** `data/WPP2024_PopulationBySingleAgeSex_Medium_1950-2023.csv`

**Setup:**
1. Go to UN WPP Downloads page
2. Download "Population by Single Age - Both Sexes" (CSV format, Medium variant, 1950-2023)
3. Place the CSV file in `data/` at repository root

**Expected Columns:** `Location`, `Time`, `AgeGrpStart`, `AgeGrpSpan`, `PopMale`, `PopFemale`, etc.

### Japan Population Data (Tracked)

**File:** `data-pipeline/jpop.csv` (**tracked by Git**)

**Source:** Minato Nakazawa's [fmsb R package](https://cran.r-project.org/package=fmsb), which processed data from Statistics Bureau, Ministry of Internal Affairs and Communications: Population Census, 1888-2020.

This file is already included in the repository and does not require manual download. It provides population by age and sex for Japan (census date: October 1st each year).

### Directory Structure After Setup

```
birth-heatmaps/
├── data/                                    # Untracked raw data
│   ├── hmd_countries_YYYYMMDD/             # HMD bulk download
│   │   ├── USA/InputDB/
│   │   │   ├── USAbirthbymonth.txt
│   │   │   └── USApop.txt
│   │   ├── JPN/InputDB/
│   │   │   ├── JPNbirthbymonth.txt
│   │   │   └── JPNpop.txt
│   │   └── .../
│   ├── un_births_by_month_data_raw.csv     # UN births by month
│   └── WPP2024_PopulationBySingleAgeSex_Medium_1950-2023.csv  # UN WPP
├── data-pipeline/
│   ├── jpop.csv                            # Japan population (tracked)
│   └── ...
└── frontend/
```

## Environment Variables

- `HMD_DATA_DIR` - Override HMD data directory (default: auto-detects bulk download in `../data/hmd_countries_*`, falls back to `../hmd_data`)
- `UN_DATA_DIR` - Path to UN data directory (default: `../data`)
- `OUTPUT_DIR` - Pipeline output directory (default: `./output`)
- `FRONTEND_ASSETS_DATA_DIR` - Frontend assets directory (default: `../frontend/src/assets/data`)

These are configured in [.vscode/launch.json](../.vscode/launch.json) for local development and in [docker-compose.yml](../docker-compose.yml) for Docker.

## Testing

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src

# Run specific test
pytest tests/test_exporters.py
```

## Metrics Computed

The pipeline computes several fertility and seasonality metrics:

- **Daily Fertility Rate (DFR)**: Births per day per 100,000 women aged 15-44
- **12-Month Moving Average**: Smoothed fertility trend
- **Seasonality Ratio (12-month)**: DFR / 12-month moving average
- **Seasonality Ratio (Annual)**: Percentage of annual births per month (normalized to 30-day months)

See [../README.md](../README.md) for more details on the metrics.
