# US State-Level Frontend Integration Progress

This document tracks the implementation progress of US state-level birth data integration into the frontend.

## Overview

The goal is to integrate US state-level birth data (already generated by the data pipeline) into the Astro frontend, including individual state pages, compare functionality, OG images, and E2E tests.

## Implementation Phases

### Phase 0: Pipeline - Bypass State Filtering âœ…

**Status:** Complete

**Goal:** Ensure all 50 states + DC are included regardless of data completeness (unlike countries which use quality filters).

**Files Modified:**
- `data-pipeline/scripts/run_pipeline.py` - Pass `min_years=0, min_monthly_births=0` for state exports
- `STATES.md` - Updated documentation to reflect all 51 states included

**Result:** Pipeline now exports all 51 states without filtering.

---

### Phase 1: Type System Updates âœ…

**Status:** Complete

**Goal:** Add TypeScript types for state data structures.

**Files Modified:**
- `frontend/src/lib/types.ts` - Added:
  - `StateMeta` interface (mirrors `CountryMeta`)
  - `StateHeatmapData` interface (uses `state` key instead of `country`)
  - `StatesIndex` interface
  - Updated `CompareQueryParams` to include `states: string[]`

**Files Created:**
- `frontend/src/lib/normalize-data.ts` - Utility functions:
  - `stateToCountryFormat()` - Transform state data to country format for component reuse
  - `isStateHeatmapData()` - Type guard
  - `normalizeHeatmapData()` - Normalize any heatmap data to country format

---

### Phase 2: State Heatmap Pages âœ…

**Status:** Complete

**Goal:** Create individual state pages following the country page pattern.

**Files Created:**
- `frontend/src/pages/[metric]/states/[state].astro` - State heatmap pages
  - Loads from `states.json` and `fertility/states/*.json`
  - Transforms state data to `CountryHeatmapData` format at build time
  - Breadcrumb: "Countries / US States / {State Name}"
  - Compare link uses `states=` parameter
  - OG URL: `/og/{metric}/states/{state}.png`

- `frontend/src/components/svelte/StateDropdown.svelte` - Navigation dropdown
  - Adapted from `CountryDropdown.svelte`
  - Props: `states: StateMeta[]`, `currentState`, `metric`, `variant`
  - Navigates to `/{metric}/states/{code}`
  - Test IDs: `state-dropdown-*`

---

### Phase 3: Index Page Updates âœ…

**Status:** Complete

**Goal:** Add states section to homepage with navigation.

**Files Modified:**
- `frontend/src/pages/index.astro`:
  - Import `states.json` data
  - Added anchor nav links at top: "Countries | US States"
  - Added `id="countries"` to countries section
  - Added new US States section with `id="states"`:
    - 5-column grid of state cards (smaller than country cards)
    - Links to `/fertility/states/{code}`
    - Shows year range for each state

---

### Phase 4: OG Image Generation âœ…

**Status:** Complete

**Goal:** Generate OpenGraph images for state pages.

**Files Created:**
- `frontend/src/pages/og/[metric]/states/[state].png.ts`
  - Mirrors `og/[metric]/[country].png.ts` pattern
  - Loads state JSON via `import.meta.glob`
  - Transforms to `CountryHeatmapData` format
  - Uses existing `renderHeatmapToPNG()` function

---

### Phase 5: Compare Page - URL & Data Layer âœ…

**Status:** Complete

**Goal:** Update URL parameter handling and data loading for states.

**Files Modified:**
- `frontend/src/lib/url-params.ts`:
  - Added `states` parsing in `parseCompareParams()`
  - Added `states` serialization in `serializeCompareParams()`
  - URL format: `/compare?countries=usa&states=california,texas&metric=fertility`

- `frontend/src/lib/compare-data.ts`:
  - Added `loadStateMetricData(stateCode, metric)` - Fetch from `/data/{metric}/states/{code}.json`
  - Added `loadMultipleStates(stateCodes, metric)` - Parallel fetch with `Promise.allSettled`
  - Both functions transform to `CountryHeatmapData` format

- `frontend/src/lib/url-params.test.ts`:
  - Added tests for states parameter parsing/serialization
  - Updated existing tests to include `states: []`

---

### Phase 6: Compare Page - UI Components âœ…

**Status:** Complete

**Goal:** Add state selection UI to compare page.

**Files Created:**
- `frontend/src/components/svelte/StateMultiSelect.svelte`
  - Adapted from `CountryMultiSelect.svelte`
  - Props: `states: StateMeta[]`, `selected`, `onChange`, `maxDisplay`
  - Test IDs: `state-multiselect-*`

**Files Modified:**
- `frontend/src/pages/compare.astro`:
  - Import `states.json`
  - Pass `states` prop to `ComparePageClient`
  - Updated title/description for "Countries & States"

- `frontend/src/components/svelte/ComparePageClient.svelte`:
  - Accept `states: StateMeta[]` prop
  - Added `selectedStates` state array
  - Added `loadedStateData` record
  - Added `StateMultiSelect` component below country dropdown
  - Combined country and state data for heatmap display
  - Updated URL sync to include states parameter

---

### Phase 7: E2E Tests âœ…

**Status:** Complete

**Goal:** Add Playwright tests for state functionality.

**Files Created:**
- `frontend/e2e/state-pages.spec.ts` (16 tests):
  - Homepage states section visibility
  - State card display (51 states)
  - Navigation between countries and states
  - State page navigation from homepage
  - Breadcrumb verification
  - Heatmap rendering on state pages
  - Axes and controls visibility
  - Metric tab switching (fertility â†’ seasonality â†’ conception)
  - State dropdown navigation
  - Compare link presence

- `frontend/e2e/compare-states.spec.ts` (14 tests):
  - States dropdown visibility and interaction
  - State search functionality
  - State selection
  - URL parameter loading
  - URL updates on selection
  - Mixed countries and states selection
  - State heatmap rendering in comparison
  - Scale mode with states
  - Metric switching with states

**Files Modified:**
- `frontend/e2e/fixtures/test-data.ts`:
  - Added `TEST_STATE` constant (California)

**Test Results:** All 30 tests passing

---

### Phase 8: State Chart Generation ðŸ”²

**Status:** Pending

**Goal:** Generate static PNG charts for state pages (chart galleries like countries have).

**Files to Modify:**
- `data-pipeline/src/exporters/chart_exporter.py` - Add `export_state_charts()` function
- `data-pipeline/scripts/run_pipeline.py` - Call state chart export when `--states` and `--charts` both set

**Output:**
- `charts/states/{state-slug}/` directory with PNG charts

---

## Build Results

- **Pages Built:** 342 (includes all state/metric combinations)
- **Unit Tests:** 112 passing
- **E2E Tests:** 30 passing (16 state-pages + 14 compare-states)

## Key Files Reference

### New Files
| File | Purpose |
|------|---------|
| `frontend/src/pages/[metric]/states/[state].astro` | State heatmap pages |
| `frontend/src/pages/og/[metric]/states/[state].png.ts` | State OG images |
| `frontend/src/components/svelte/StateDropdown.svelte` | State navigation |
| `frontend/src/components/svelte/StateMultiSelect.svelte` | State multi-select |
| `frontend/src/lib/normalize-data.ts` | Data transformation utilities |
| `frontend/e2e/state-pages.spec.ts` | State page E2E tests |
| `frontend/e2e/compare-states.spec.ts` | Compare states E2E tests |

### Modified Files
| File | Changes |
|------|---------|
| `frontend/src/lib/types.ts` | Added state types |
| `frontend/src/lib/url-params.ts` | States URL parameter support |
| `frontend/src/lib/compare-data.ts` | State data loading functions |
| `frontend/src/pages/index.astro` | States section on homepage |
| `frontend/src/pages/compare.astro` | Pass states to client component |
| `frontend/src/components/svelte/ComparePageClient.svelte` | State selection UI |
| `data-pipeline/scripts/run_pipeline.py` | Bypass state filtering |

## URL Patterns

| URL | Description |
|-----|-------------|
| `/fertility/states/california` | California fertility heatmap |
| `/seasonality/states/texas` | Texas seasonality heatmap |
| `/conception/states/new-york` | New York conception heatmap |
| `/compare?states=california,texas` | Compare two states |
| `/compare?countries=japan&states=california` | Compare country with state |
| `/og/fertility/states/california.png` | California OG image |

## Notes

- State JSON uses `"state": {code, name}` key vs country JSON using `"country": {code, name}`
- Data normalization transforms state format to country format for component reuse
- All 51 states included (50 states + DC) without data quality filtering
- State slugs follow same pattern as countries: "New York" â†’ `new-york`
